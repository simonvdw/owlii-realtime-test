/**
 * Bundled by jsDelivr using Rollup v2.79.2 and Terser v5.39.0.
 * Original file: /npm/@openai/agents-realtime@0.3.4/dist/index.mjs
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
import{RunToolApprovalItem as t,Agent as e,defineOutputGuardrail as i,getLogger as n,RuntimeEventEmitter as o,Usage as s,UserError as r,RunContext as a,getTransferMessage as p,ModelBehaviorError as u,OutputGuardrailTripwireTriggered as l}from"/npm/@openai/agents-core@0.3.4/+esm";export{ModelBehaviorError,OutputGuardrailTripwireTriggered,UserError,tool}from"/npm/@openai/agents-core@0.3.4/+esm";import{isBrowserEnvironment as c,RuntimeEventEmitter as d}from"/npm/@openai/agents-core@0.3.4/_shims/+esm";import{EventEmitterDelegate as m,isZodObject as h,toSmartString as g}from"/npm/@openai/agents-core@0.3.4/utils/+esm";import{z as _}from"/npm/zod@4.1.13/+esm";import{isBrowserEnvironment as y,useWebSocketProtocols as f,WebSocket as v}from"/npm/@openai/agents-realtime@0.3.4/_shims/+esm";const b="0.3.4";function w(t){const e=atob(t),i=e.length,n=new Uint8Array(i);for(let t=0;t<i;t++)n[t]=e.charCodeAt(t);return n.buffer}function I(t){const e=String.fromCharCode(...new Uint8Array(t));return btoa(e)}function A(t){if(null==t||"object"!=typeof t||!("type"in t)||"string"!=typeof t.type||!t.type)return;if("message"!==t.type)return;if(!("content"in t)||!Array.isArray(t.content)||t.content.length<1)return;const e=t.content[t.content.length-1];return"type"in e&&"string"==typeof e.type?"output_text"===e.type?"string"==typeof e.text?e.text:void 0:"output_audio"===e.type&&"string"==typeof e.transcript?e.transcript:void 0:void 0}function x(t){return"system"===t.role?t:"assistant"===t.role?{...t,content:t.content.map((t=>"output_audio"===t.type?{...t,audio:null}:t))}:"user"===t.role?{...t,content:t.content.map((t=>"input_audio"===t.type?{...t,audio:null}:t))}:t}function C(t,e,i){if("conversation.item.input_audio_transcription.completed"===e.type)return t.map((t=>{if(t.itemId===e.item_id&&"message"===t.type&&"role"in t&&"user"===t.role){const i=t.content.map((t=>"input_audio"===t.type?{...t,transcript:e.transcript}:t));return{...t,content:i,status:"completed"}}return t}));const n=i||"message"!==e.type?e:x(e),o=t.findIndex((t=>t.itemId===e.itemId));if(-1!==o){const e=t[o],s="message"===n.type&&"message"===e.type?function(t,e){if("assistant"!==t.role||"assistant"!==e.role)return e;const i=e.content.map(((e,i)=>{if("output_audio"!==e.type)return e;if("string"==typeof e.transcript&&0!==e.transcript.length)return e;const n=t.content[i];return n&&"output_audio"===n.type&&"string"==typeof n.transcript&&n.transcript.length>0?{...e,transcript:n.transcript}:e}));return{...e,content:i}}(e,n):n;return t.map(((t,e)=>e===o?s:i||"message"!==t.type?t:x(t)))}if(e.previousItemId){const i=t.findIndex((t=>t.itemId===e.previousItemId));return-1!==i?[...t.slice(0,i+1),n,...t.slice(i+1)]:[...t,n]}return[...t,n]}const S={"User-Agent":`Agents/JavaScript ${b}`,"X-OpenAI-Agents-SDK":`openai-agents-sdk.${b}`},T=`openai-agents-sdk.${b}`;function j(e,i){const{name:n,arguments:o,...s}=i;return new t({type:"hosted_tool_call",name:n,arguments:JSON.stringify(o),status:"in_progress",providerData:{...s}},e)}function k(t){if("function_call"!==t.rawItem.type&&"hosted_tool_call"!==t.rawItem.type)throw new Error("Invalid approval item type for Realtime MCP approval request");const{name:e,arguments:i,providerData:n}=t.rawItem,{itemId:o,serverLabel:s,...r}=n??{};if(!o||!s)throw new Error("Invalid approval item for Realtime MCP approval request");return{type:"mcp_approval_request",itemId:o,serverLabel:s,...r,name:e,arguments:i?JSON.parse(i):{},approved:null}}class M extends e{voice;constructor(t){super(t),this.voice=t.voice}}function E({policyHint:t,...e}){const n=i(e),o=t??n.name;return{...n,policyHint:o,run:async t=>{const e=await n.run(t);return{...e,guardrail:{...e.guardrail,policyHint:o}}}}}function R(t,e){return t in e&&void 0!==e[t]}function D(t){if(!function(t){return R("modalities",t)||R("inputAudioFormat",t)||R("outputAudioFormat",t)||R("inputAudioTranscription",t)||R("turnDetection",t)||R("inputAudioNoiseReduction",t)||R("speed",t)}(t)){const e=t.audio?.input?{format:O(t.audio.input.format),noiseReduction:t.audio.input.noiseReduction??null,transcription:t.audio.input.transcription,turnDetection:t.audio.input.turnDetection}:void 0,i=t.audio?.output?.voice??t.voice,n=t.audio?.output||void 0!==i?{format:O(t.audio?.output?.format),voice:i,speed:t.audio?.output?.speed}:void 0;return{model:t.model,instructions:t.instructions,toolChoice:t.toolChoice,tools:t.tools,tracing:t.tracing,providerData:t.providerData,prompt:t.prompt,outputModalities:t.outputModalities,audio:e||n?{input:e,output:n}:void 0}}return{model:t.model,instructions:t.instructions,toolChoice:t.toolChoice,tools:t.tools,tracing:t.tracing,providerData:t.providerData,prompt:t.prompt,outputModalities:t.modalities,audio:{input:{format:O(t.inputAudioFormat),noiseReduction:t.inputAudioNoiseReduction??null,transcription:t.inputAudioTranscription,turnDetection:t.turnDetection},output:{format:O(t.outputAudioFormat),voice:t.voice,speed:t.speed}}}}function O(t){if(!t)return;if("object"==typeof t)return t;const e=String(t);return"pcm16"===e?{type:"audio/pcm",rate:24e3}:"g711_ulaw"===e?{type:"audio/pcmu"}:"g711_alaw"===e?{type:"audio/pcma"}:{type:"audio/pcm",rate:24e3}}_.object({itemId:_.string()});const L=_.discriminatedUnion("role",[_.object({itemId:_.string(),previousItemId:_.string().nullable().optional(),type:_.literal("message"),role:_.literal("system"),content:_.array(_.object({type:_.literal("input_text"),text:_.string()}))}),_.object({itemId:_.string(),previousItemId:_.string().nullable().optional(),type:_.literal("message"),role:_.literal("user"),status:_.enum(["in_progress","completed"]),content:_.array(_.object({type:_.literal("input_text"),text:_.string()}).or(_.object({type:_.literal("input_audio"),audio:_.string().nullable().optional(),transcript:_.string().nullable()})))}),_.object({itemId:_.string(),previousItemId:_.string().nullable().optional(),type:_.literal("message"),role:_.literal("assistant"),status:_.enum(["in_progress","completed","incomplete"]),content:_.array(_.object({type:_.literal("output_text"),text:_.string()}).or(_.object({type:_.literal("output_audio"),audio:_.string().nullable().optional(),transcript:_.string().nullable().optional()})))})]),P=_.object({itemId:_.string(),previousItemId:_.string().nullable().optional(),type:_.literal("function_call"),status:_.enum(["in_progress","completed","incomplete"]),arguments:_.string(),name:_.string(),output:_.string().nullable()}),N=_.object({itemId:_.string(),previousItemId:_.string().nullable().optional(),type:_.enum(["mcp_call","mcp_tool_call"]),status:_.enum(["in_progress","completed","incomplete"]),arguments:_.string(),name:_.string(),output:_.string().nullable()}),K=_.object({itemId:_.string(),type:_.literal("mcp_approval_request"),serverLabel:_.string(),name:_.string(),arguments:_.record(_.string(),_.any()),approved:_.boolean().optional().nullable()}),F=n("openai-agents:realtime"),G=_.object({id:_.string().optional().nullable(),conversation_id:_.string().optional().nullable(),max_output_tokens:_.number().or(_.literal("inf")).optional().nullable(),metadata:_.record(_.string(),_.any()).optional().nullable(),output_modalities:_.array(_.string()).optional().nullable(),object:_.literal("realtime.response").optional().nullable(),output:_.array(_.any()).optional().nullable(),audio:_.object({output:_.object({format:_.any().optional().nullable(),voice:_.string().optional().nullable()}).optional().nullable()}).optional().nullable(),status:_.enum(["completed","incomplete","failed","cancelled","in_progress"]).optional().nullable(),status_details:_.record(_.string(),_.any()).optional().nullable(),usage:_.object({input_tokens:_.number().optional(),input_token_details:_.record(_.string(),_.any()).optional().nullable(),output_tokens:_.number().optional(),output_token_details:_.record(_.string(),_.any()).optional().nullable()}).optional().nullable()}),q=_.object({id:_.string().optional(),audio:_.string().nullable().optional(),text:_.string().nullable().optional(),transcript:_.string().nullable().optional(),type:_.union([_.literal("input_text"),_.literal("input_audio"),_.literal("item_reference"),_.literal("output_text"),_.literal("output_audio")])}),J=_.object({id:_.string().optional(),arguments:_.string().optional(),call_id:_.string().optional(),content:_.array(q).optional(),name:_.string().optional(),output:_.string().nullable().optional(),role:_.enum(["user","assistant","system"]).optional(),status:_.enum(["completed","incomplete","in_progress"]).optional(),type:_.enum(["message","function_call","function_call_output","mcp_list_tools","mcp_tool_call","mcp_call","mcp_approval_request","mcp_approval_response"]).optional(),approval_request_id:_.string().nullable().optional(),approve:_.boolean().nullable().optional(),reason:_.string().nullable().optional(),server_label:_.string().optional(),error:_.any().nullable().optional(),tools:_.array(_.object({name:_.string(),description:_.string(),input_schema:_.record(_.any()).optional()}).passthrough()).optional()}).passthrough(),U=_.object({type:_.literal("conversation.created"),event_id:_.string(),conversation:_.object({id:_.string().optional(),object:_.literal("realtime.conversation").optional()})}),W=_.object({type:_.literal("conversation.item.added"),event_id:_.string(),item:J,previous_item_id:_.string().nullable().optional()}),H=_.object({type:_.literal("conversation.item.done"),event_id:_.string(),item:J,previous_item_id:_.string().nullable().optional()}),B=_.object({type:_.literal("conversation.item.deleted"),event_id:_.string(),item_id:_.string()}),$=_.object({type:_.literal("conversation.item.input_audio_transcription.completed"),event_id:_.string(),item_id:_.string(),content_index:_.number(),transcript:_.string(),logprobs:_.array(_.any()).nullable().optional()}),z=_.object({type:_.literal("conversation.item.input_audio_transcription.delta"),event_id:_.string(),item_id:_.string(),content_index:_.number().optional(),delta:_.string().optional(),logprobs:_.array(_.any()).nullable().optional()}),X=_.object({type:_.literal("conversation.item.input_audio_transcription.failed"),event_id:_.string(),item_id:_.string(),content_index:_.number(),error:_.object({code:_.string().optional(),message:_.string().optional(),param:_.string().optional(),type:_.string().optional()})}),Y=_.object({type:_.literal("conversation.item.retrieved"),event_id:_.string(),item:J}),V=_.object({type:_.literal("conversation.item.truncated"),event_id:_.string(),item_id:_.string(),audio_end_ms:_.number(),content_index:_.number()}),Q=_.object({type:_.literal("conversation.item.create"),item:J,event_id:_.string().optional(),previous_item_id:_.string().nullable().optional()}),Z=_.object({type:_.literal("conversation.item.delete"),item_id:_.string(),event_id:_.string().optional()}),tt=_.object({type:_.literal("conversation.item.retrieve"),item_id:_.string(),event_id:_.string().optional()}),et=_.object({type:_.literal("conversation.item.truncate"),item_id:_.string(),audio_end_ms:_.number(),content_index:_.number(),event_id:_.string().optional()}),it=_.object({type:_.literal("error"),event_id:_.string().optional(),error:_.any().optional()}),nt=_.object({type:_.literal("input_audio_buffer.cleared"),event_id:_.string()}),ot=_.object({type:_.literal("input_audio_buffer.append"),audio:_.string(),event_id:_.string().optional()}),st=_.object({type:_.literal("input_audio_buffer.clear"),event_id:_.string().optional()}),rt=_.object({type:_.literal("input_audio_buffer.commit"),event_id:_.string().optional()}),at=_.object({type:_.literal("input_audio_buffer.committed"),event_id:_.string(),item_id:_.string(),previous_item_id:_.string().nullable().optional()}),pt=_.object({type:_.literal("input_audio_buffer.speech_started"),event_id:_.string(),item_id:_.string(),audio_start_ms:_.number()}),ut=_.object({type:_.literal("input_audio_buffer.speech_stopped"),event_id:_.string(),item_id:_.string(),audio_end_ms:_.number()}),lt=_.object({type:_.literal("output_audio_buffer.started"),event_id:_.string()}).passthrough(),ct=_.object({type:_.literal("output_audio_buffer.stopped"),event_id:_.string()}).passthrough(),dt=_.object({type:_.literal("output_audio_buffer.cleared"),event_id:_.string()}),mt=_.object({type:_.literal("rate_limits.updated"),event_id:_.string(),rate_limits:_.array(_.object({limit:_.number().optional(),name:_.enum(["requests","tokens"]).optional(),remaining:_.number().optional(),reset_seconds:_.number().optional()}))}),ht=_.object({type:_.literal("response.output_audio.delta"),event_id:_.string(),item_id:_.string(),content_index:_.number(),delta:_.string(),output_index:_.number(),response_id:_.string()}),gt=_.object({type:_.literal("response.output_audio.done"),event_id:_.string(),item_id:_.string(),content_index:_.number(),output_index:_.number(),response_id:_.string()}),_t=_.object({type:_.literal("response.output_audio_transcript.delta"),event_id:_.string(),item_id:_.string(),content_index:_.number(),delta:_.string(),output_index:_.number(),response_id:_.string()}),yt=_.object({type:_.literal("response.output_audio_transcript.done"),event_id:_.string(),item_id:_.string(),content_index:_.number(),transcript:_.string(),output_index:_.number(),response_id:_.string()}),ft=_.object({type:_.literal("response.content_part.added"),event_id:_.string(),item_id:_.string(),content_index:_.number(),output_index:_.number(),response_id:_.string(),part:_.object({audio:_.string().optional(),text:_.string().optional(),transcript:_.string().optional(),type:_.enum(["text","audio"]).optional()})}),vt=_.object({type:_.literal("response.content_part.done"),event_id:_.string(),item_id:_.string(),content_index:_.number(),output_index:_.number(),response_id:_.string(),part:_.object({audio:_.string().optional(),text:_.string().optional(),transcript:_.string().optional(),type:_.enum(["text","audio"]).optional()})}),bt=_.object({type:_.literal("response.created"),event_id:_.string(),response:G}),wt=_.object({type:_.literal("response.done"),event_id:_.string(),response:G}),It=_.object({type:_.literal("response.function_call_arguments.delta"),event_id:_.string(),item_id:_.string(),call_id:_.string(),delta:_.string(),output_index:_.number(),response_id:_.string()}),At=_.object({type:_.literal("response.function_call_arguments.done"),event_id:_.string(),item_id:_.string(),call_id:_.string(),arguments:_.string(),output_index:_.number(),response_id:_.string()}),xt=_.object({type:_.literal("response.output_item.added"),event_id:_.string(),item:J,output_index:_.number(),response_id:_.string()}),Ct=_.object({type:_.literal("response.output_item.done"),event_id:_.string(),item:J,output_index:_.number(),response_id:_.string()}),St=_.object({type:_.literal("response.output_text.delta"),event_id:_.string(),item_id:_.string(),content_index:_.number(),delta:_.string(),output_index:_.number(),response_id:_.string()}),Tt=_.object({type:_.literal("response.output_text.done"),event_id:_.string(),item_id:_.string(),content_index:_.number(),text:_.string(),output_index:_.number(),response_id:_.string()}),jt=_.object({type:_.literal("session.created"),event_id:_.string(),session:_.any()}),kt=_.object({type:_.literal("session.updated"),event_id:_.string(),session:_.any()}),Mt=_.object({type:_.literal("response.cancel"),event_id:_.string().optional(),response_id:_.string().optional()}),Et=_.object({type:_.literal("response.create"),event_id:_.string().optional(),response:_.any().optional()}),Rt=_.object({type:_.literal("session.update"),event_id:_.string().optional(),session:_.any()}),Dt=_.object({type:_.literal("mcp_list_tools.in_progress"),event_id:_.string().optional(),item_id:_.string().optional()}),Ot=_.object({type:_.literal("mcp_list_tools.completed"),event_id:_.string().optional(),item_id:_.string().optional()}),Lt=_.object({type:_.literal("response.mcp_call_arguments.delta"),event_id:_.string(),response_id:_.string(),item_id:_.string(),output_index:_.number(),delta:_.string(),obfuscation:_.string()}),Pt=_.object({type:_.literal("response.mcp_call_arguments.done"),event_id:_.string(),response_id:_.string(),item_id:_.string(),output_index:_.number(),arguments:_.string()}),Nt=_.object({type:_.literal("response.mcp_call.in_progress"),event_id:_.string(),output_index:_.number(),item_id:_.string()}),Kt=_.object({type:_.literal("response.mcp_call.completed"),event_id:_.string(),output_index:_.number(),item_id:_.string()}),Ft=_.object({type:_.literal("mcp_list_tools.failed"),event_id:_.string().optional(),item_id:_.string().optional()}),Gt=_.object({type:_.string(),event_id:_.string().optional().nullable()}).passthrough(),qt=_.discriminatedUnion("type",[U,W,H,B,$,z,X,Y,V,it,nt,at,pt,ut,lt,ct,dt,mt,ht,gt,_t,yt,ft,vt,bt,wt,It,At,xt,Ct,St,Tt,jt,kt,Dt,Ot,Ft,Lt,Pt,Nt,Kt]);function Jt(t){const e=JSON.parse(t.data.toString()),i=qt.safeParse(e);if(!i.success){const t=Gt.safeParse(e);return t.success?{data:t.data,isGeneric:!0}:{data:null,isGeneric:!0}}return{data:i.data,isGeneric:!1}}_.discriminatedUnion("type",[Q,Z,tt,et,ot,st,rt,Mt,Et,Rt]);const Ut="gpt-realtime",Wt={outputModalities:["audio"],audio:{input:{format:{type:"audio/pcm",rate:24e3},transcription:{model:"gpt-4o-mini-transcribe"},turnDetection:{type:"semantic_vad"},noiseReduction:null},output:{format:{type:"audio/pcm",rate:24e3},speed:1}}};class Ht extends m{#t;#e;#i=null;#n=null;eventEmitter=new o;constructor(t={}){super(),this.#t=t.model??Ut,this.#e=t.apiKey}get currentModel(){return this.#t}set currentModel(t){this.#t=t}_afterAudioDoneEvent(){}get _rawSessionConfig(){return this.#n??null}async _getApiKey(t){const e=t.apiKey??this.#e;return"function"==typeof e?await e():e}_onMessage(t){const{data:e,isGeneric:i}=Jt(t);if(null!==e&&(this.emit("*",e),!i))if("error"===e.type?this.emit("error",{type:"error",error:e}):this.emit(e.type,e),"response.created"!==e.type){if("session.updated"===e.type&&(this.#n=e.session),"response.done"===e.type){const t=wt.safeParse(e);if(!t.success)return void F.error("Error parsing response done event",t.error);const i=t.data.response.usage?.input_tokens??0,n=t.data.response.usage?.output_tokens??0,o=i+n,r=new s({inputTokens:i,inputTokensDetails:t.data.response.usage?.input_token_details??{},outputTokens:n,outputTokensDetails:t.data.response.usage?.output_token_details??{},totalTokens:o});return this.emit("usage_update",r),void this.emit("turn_done",{type:"response_done",response:{id:t.data.response.id??"",output:t.data.response.output??[],usage:{inputTokens:i,inputTokensDetails:t.data.response.usage?.input_token_details??{},outputTokens:n,outputTokensDetails:t.data.response.usage?.output_token_details??{},totalTokens:o}}})}if("response.output_audio.done"===e.type)return this.emit("audio_done"),void this._afterAudioDoneEvent();if("conversation.item.deleted"!==e.type)if("conversation.item.input_audio_transcription.completed"!==e.type&&"conversation.item.truncated"!==e.type)if("conversation.item.input_audio_transcription.delta"!==e.type&&"response.output_text.delta"!==e.type&&"response.output_audio_transcript.delta"!==e.type&&"response.function_call_arguments.delta"!==e.type){if("conversation.item.added"===e.type||"conversation.item.done"===e.type||"conversation.item.retrieved"===e.type){if("mcp_list_tools"===e.item.type&&"conversation.item.done"===e.type){const t=e.item.server_label??"",i=e.item.tools??[];try{this.emit("mcp_tools_listed",{serverLabel:t,tools:i})}catch(t){F.error("Error emitting mcp_tools_listed",t,e.item)}return}if("message"===e.item.type){const t="conversation.item.added"===e.type||"conversation.item.done"===e.type?e.previous_item_id:null,i=L.parse({itemId:e.item.id,previousItemId:t,type:e.item.type,role:e.item.role,content:e.item.content,status:e.item.status});return void this.emit("item_update",i)}if("mcp_approval_request"===e.item.type&&"conversation.item.done"===e.type){const t=e.item,i=K.parse({itemId:t.id,type:t.type,serverLabel:t.server_label,name:t.name,arguments:JSON.parse(t.arguments||"{}"),approved:t.approved});return this.emit("item_update",i),void this.emit("mcp_approval_request",i)}if("mcp_tool_call"===e.item.type||"mcp_call"===e.item.type){const t="conversation.item.done"===e.type?"completed":"in_progress",i=N.parse({itemId:e.item.id,type:e.item.type,status:t,arguments:e.item.arguments,name:e.item.name,output:e.item.output});return this.emit("item_update",i),void("conversation.item.done"===e.type&&this.emit("mcp_tool_call_completed",i))}}if("response.mcp_call.in_progress"!==e.type)if("mcp_list_tools.in_progress"!==e.type){if("response.output_item.done"===e.type||"response.output_item.added"===e.type){const t=e.item;if("function_call"===t.type&&"completed"===t.status){const e=P.parse({itemId:t.id,type:t.type,status:"in_progress",arguments:t.arguments,name:t.name,output:null});return this.emit("item_update",e),void this.emit("function_call",{id:t.id,type:"function_call",callId:t.call_id??"",arguments:t.arguments??"",name:t.name??""})}if("mcp_tool_call"===t.type||"mcp_call"===t.type){const i=N.parse({itemId:t.id,type:t.type,status:"response.output_item.done"===e.type?"completed":"in_progress",arguments:t.arguments,name:t.name,output:t.output});return void this.emit("item_update",i)}if("message"===t.type){const i=L.parse({itemId:e.item.id,type:e.item.type,role:e.item.role,content:e.item.content,status:"response.output_item.done"===e.type?t.status??"completed":t.status??"in_progress"});return void this.emit("item_update",i)}}}else{const t=e;t.item_id&&this.sendEvent({type:"conversation.item.retrieve",item_id:t.item_id})}else{const t=e;this.sendEvent({type:"conversation.item.retrieve",item_id:t.item_id})}}else"response.output_audio_transcript.delta"===e.type&&this.emit("audio_transcript_delta",{type:"transcript_delta",delta:e.delta,itemId:e.item_id,responseId:e.response_id});else this.sendEvent({type:"conversation.item.retrieve",item_id:e.item_id});else this.emit("item_deleted",{itemId:e.item_id})}else this.emit("turn_started",{type:"response_started",providerData:{...e}})}_onError(t){this.emit("error",{type:"error",error:t})}_onOpen(){this.emit("connected")}_onClose(){this.emit("disconnected")}sendMessage(t,e,{triggerResponse:i=!0}={}){const n="string"==typeof t?[{type:"input_text",text:t}]:t.content.map((t=>"input_image"===t.type?{type:"input_image",image_url:t.image,...t.providerData??{}}:t));this.sendEvent({type:"conversation.item.create",item:{type:"message",role:"user",content:n},...e}),i&&this.sendEvent({type:"response.create"})}addImage(t,{triggerResponse:e=!0}={}){this.sendMessage({type:"message",role:"user",content:[{type:"input_image",image:t}]},{},{triggerResponse:e})}_getMergedSessionConfig(t){const e=D(t),i={type:"realtime",instructions:e.instructions,model:e.model??this.#t,output_modalities:e.outputModalities??Wt.outputModalities,audio:{input:{format:e.audio?.input?.format??Wt.audio?.input?.format,noise_reduction:e.audio?.input?.noiseReduction??Wt.audio?.input?.noiseReduction,transcription:e.audio?.input?.transcription??Wt.audio?.input?.transcription,turn_detection:Ht.buildTurnDetectionConfig(e.audio?.input?.turnDetection)??Wt.audio?.input?.turnDetection},output:{format:e.audio?.output?.format??Wt.audio?.output?.format,voice:e.audio?.output?.voice??Wt.audio?.output?.voice,speed:e.audio?.output?.speed??Wt.audio?.output?.speed}},tool_choice:e.toolChoice??Wt.toolChoice,...e.providerData??{}};return e.prompt&&(i.prompt={id:e.prompt.promptId,version:e.prompt.version,variables:e.prompt.variables}),e.tools&&e.tools.length>0&&(i.tools=e.tools.map((t=>({...t,strict:void 0})))),i}buildSessionPayload(t){return this._getMergedSessionConfig(t)}static buildTurnDetectionConfig(t){if(void 0===t)return;const{type:e,createResponse:i,create_response:n,eagerness:o,interruptResponse:s,interrupt_response:r,prefixPaddingMs:a,prefix_padding_ms:p,silenceDurationMs:u,silence_duration_ms:l,threshold:c,idleTimeoutMs:d,idle_timeout_ms:m,...h}=t,g={type:e,create_response:i||n,eagerness:o,interrupt_response:s||r,prefix_padding_ms:a||p,silence_duration_ms:u||l,idle_timeout_ms:d||m,threshold:c,...h};return Object.keys(g).forEach((t=>{void 0===g[t]&&delete g[t]})),Object.keys(g).length>0?g:void 0}set _tracingConfig(t){this.#i=t}_updateTracingConfig(t){if(void 0===this.#i&&(this.#i=null),"auto"!==t){if(null===this.#i||"string"==typeof this.#i||"string"==typeof t)return null===t?(F.debug("Disabling tracing for this session. It cannot be turned on for this session from this point on."),void this.sendEvent({type:"session.update",session:{type:"realtime",tracing:null}})):void(null!==this.#i&&"string"!=typeof this.#i?t?.group_id===this.#i?.group_id&&t?.metadata===this.#i?.metadata&&t?.workflow_name===this.#i?.workflow_name?this.sendEvent({type:"session.update",session:{type:"realtime",tracing:t}}):F.warn("Mismatch in tracing config. Ignoring the new tracing config. This likely happens when you already set a tracing config on session creation. Current tracing config: %s, new tracing config: %s",JSON.stringify(this.#i),JSON.stringify(t)):this.sendEvent({type:"session.update",session:{type:"realtime",tracing:t}}));F.warn("Tracing config is already set, skipping setting it again. This likely happens when you already set a tracing config on session creation.")}else this.sendEvent({type:"session.update",session:{type:"realtime",tracing:"auto"}})}updateSessionConfig(t){const e=this.buildSessionPayload(t);this.sendEvent({type:"session.update",session:e})}sendFunctionCallOutput(t,e,i=!0){this.sendEvent({type:"conversation.item.create",item:{type:"function_call_output",output:e,call_id:t.callId}});try{const i=P.parse({itemId:t.id,previousItemId:t.previousItemId,type:"function_call",status:"completed",arguments:t.arguments,name:t.name,output:e});this.emit("item_update",i)}catch(e){F.error("Error parsing tool call item",e,t)}i&&this.sendEvent({type:"response.create"})}sendAudio(t,{commit:e=!1}={}){this.sendEvent({type:"input_audio_buffer.append",audio:I(t)}),e&&this.sendEvent({type:"input_audio_buffer.commit"})}resetHistory(t,e){const{removals:i,additions:n,updates:o}=function(t,e){return{removals:t.filter((t=>!e.some((e=>e.itemId===t.itemId)))),additions:e.filter((e=>!t.some((t=>t.itemId===e.itemId)))),updates:e.filter((e=>t.some((t=>t.itemId===e.itemId&&JSON.stringify(t)!==JSON.stringify(e)))))}}(t,e),s=new Set(i.map((t=>t.itemId)));for(const t of o)s.add(t.itemId);if(s.size>0)for(const t of s)this.sendEvent({type:"conversation.item.delete",item_id:t});const r=[...n,...o];for(const t of r)if("message"===t.type){const e={type:"message",role:t.role,content:t.content,id:t.itemId};"system"!==t.role&&t.status&&(e.status=t.status),this.sendEvent({type:"conversation.item.create",item:e})}else"function_call"===t.type&&F.warn("Function calls cannot be manually added or updated at the moment. Ignoring.")}sendMcpResponse(t,e){this.sendEvent({type:"conversation.item.create",previous_item_id:t.itemId,item:{type:"mcp_approval_response",approval_request_id:t.itemId,approve:e}})}}class Bt extends Ht{options;#o;#s={status:"disconnected",peerConnection:void 0,dataChannel:void 0,callId:void 0};#r;#a=!1;#p=!1;constructor(t={}){if("undefined"==typeof RTCPeerConnection)throw new Error("WebRTC is not supported in this environment");super(t),this.options=t,this.#o=t.baseUrl??"https://api.openai.com/v1/realtime/calls",this.#r=t.useInsecureApiKey??!1}get callId(){return this.#s.callId}get status(){return this.#s.status}get connectionState(){return this.#s}get muted(){return this.#p}async connect(t){if("connected"===this.#s.status)return;"connecting"===this.#s.status&&F.warn("Realtime connection already in progress. Please await original promise");const e=t.model??this.currentModel;this.currentModel=e;const i=t.url??this.#o,n=await this._getApiKey(t),o="string"==typeof n&&n.startsWith("ek_");if(c()&&!this.#r&&!o)throw new r("Using the WebRTC connection in a browser environment requires an ephemeral client key. If you need to use a regular API key, use the WebSocket transport or set the `useInsecureApiKey` option to true.");return new Promise((async(e,o)=>{try{const s={...t.initialSessionConfig||{},model:this.currentModel},r=new URL(i);let a=new RTCPeerConnection;const p=a.createDataChannel("oai-events");let u;const l=t=>{t.onconnectionstatechange=()=>{switch(t.connectionState){case"disconnected":case"failed":case"closed":this.close()}}};l(a),this.#s={status:"connecting",peerConnection:a,dataChannel:p,callId:u},this.emit("connection_change",this.#s.status),p.addEventListener("open",(()=>{this.#s={status:"connected",peerConnection:a,dataChannel:p,callId:u},this.updateSessionConfig(s),this.emit("connection_change",this.#s.status),this._onOpen(),e()})),p.addEventListener("error",(t=>{this.close(),this._onError(t),o(t)})),p.addEventListener("message",(t=>{this._onMessage(t);const{data:e,isGeneric:i}=Jt(t);if(e&&!i&&("response.created"===e.type?this.#a=!0:"response.done"===e.type&&(this.#a=!1),"session.created"===e.type)){this._tracingConfig=e.session.tracing;const t=void 0===s.tracing?"auto":s.tracing;this._updateTracingConfig(t)}}));const c=this.options.audioElement??document.createElement("audio");c.autoplay=!0,a.ontrack=t=>{c.srcObject=t.streams[0]};const d=this.options.mediaStream??await navigator.mediaDevices.getUserMedia({audio:!0});if(a.addTrack(d.getAudioTracks()[0]),this.options.changePeerConnection){const t=a;a=await this.options.changePeerConnection(a),t!==a&&(t.onconnectionstatechange=null),l(a),this.#s={...this.#s,peerConnection:a}}const m=await a.createOffer();if(await a.setLocalDescription(m),!m.sdp)throw new Error("Failed to create offer");const h=await fetch(r,{method:"POST",body:m.sdp,headers:{"Content-Type":"application/sdp",Authorization:`Bearer ${n}`,"X-OpenAI-Agents-SDK":S["X-OpenAI-Agents-SDK"]}});u=h.headers?.get("Location")?.split("/").pop(),this.#s={...this.#s,callId:u};const g={type:"answer",sdp:await h.text()};await a.setRemoteDescription(g)}catch(t){this.close(),this._onError(t),o(t)}}))}sendEvent(t){if(!this.#s.dataChannel||"open"!==this.#s.dataChannel.readyState)throw new Error("WebRTC data channel is not connected. Make sure you call `connect()` before sending events.");this.#s.dataChannel.send(JSON.stringify(t))}mute(t){if(this.#p=t,this.#s.peerConnection){this.#s.peerConnection.getSenders().forEach((e=>{e.track&&(e.track.enabled=!t)}))}}_afterAudioDoneEvent(){this.#a=!1}close(){if(this.#s.dataChannel&&this.#s.dataChannel.close(),this.#s.peerConnection){const t=this.#s.peerConnection;t.onconnectionstatechange=null,t.getSenders().forEach((t=>{t.track?.stop()})),t.close()}"disconnected"!==this.#s.status&&(this.#s={status:"disconnected",peerConnection:void 0,dataChannel:void 0,callId:void 0},this.emit("connection_change",this.#s.status),this._onClose())}interrupt(){this.#a&&(this.sendEvent({type:"response.cancel"}),this.#a=!1),this.sendEvent({type:"output_audio_buffer.clear"})}}class $t extends Ht{#e;#o;#u;#s={status:"disconnected",websocket:void 0};#r;#l;#c;_firstAudioTimestamp;_audioLengthMs=0;#a=!1;#d;#m;#h(){this.#l=void 0,this._firstAudioTimestamp=void 0,this._audioLengthMs=0,this.#c=void 0}constructor(t={}){super(t),this.#o=t.url,this.#u=t.url,this.#r=t.useInsecureApiKey??!1,this.#d=t.createWebSocket,this.#m=t.skipOpenEventListeners??!1}getCommonRequestHeaders(){return S}get status(){return this.#s.status}get connectionState(){return this.#s}get muted(){return null}get currentItemId(){return this.#l}_onAudio(t){this.emit("audio",t)}_afterAudioDoneEvent(){this.#h()}async#g(t,e,i){if(this.#s.websocket)return void t();if(!this.#e)throw new r("API key is not set. Please call `connect()` with an API key first.");if(y()&&!this.#e.startsWith("ek_")&&!this.#r)throw new r("Using the WebSocket connection in a browser environment requires an ephemeral client key. If you have to use a regular API key, set the `useInsecureApiKey` option to true.");let n=null;if(this.#d)n=await this.#d({url:this.#o,apiKey:this.#e});else{const t=f?["realtime","openai-insecure-api-key."+this.#e,T]:{headers:{Authorization:`Bearer ${this.#e}`,...this.getCommonRequestHeaders()}};n=new v(this.#o,t)}this.#s={status:"connecting",websocket:n},this.emit("connection_change",this.#s.status);const o=()=>{this.#s={status:"connected",websocket:n},this.emit("connection_change",this.#s.status),this._onOpen(),t()};!0===this.#m?o():n.addEventListener("open",o),n.addEventListener("error",(t=>{this._onError(t),this.#s={status:"disconnected",websocket:void 0},this.emit("connection_change",this.#s.status),e(t)})),n.addEventListener("message",(t=>{this._onMessage(t);const{data:e,isGeneric:n}=Jt(t);if(e&&!n)if("response.output_audio.delta"===e.type){this.#c=e.content_index,this.#l=e.item_id,void 0===this._firstAudioTimestamp&&(this._firstAudioTimestamp=Date.now(),this._audioLengthMs=0);const t=w(e.delta),i=this._rawSessionConfig?.audio?.output?.format;if(i&&"object"==typeof i){const e=i.type;if("audio/pcmu"===e||"audio/pcma"===e)this._audioLengthMs+=t.byteLength/8;else if("audio/pcm"===e){const e=i.rate??24e3;this._audioLengthMs+=t.byteLength/2/e*1e3}else this._audioLengthMs+=t.byteLength/24/2}else"string"==typeof i&&i.startsWith("g711_")?this._audioLengthMs+=t.byteLength/8:this._audioLengthMs+=t.byteLength/24/2;const n={type:"audio",data:t,responseId:e.response_id};this._onAudio(n)}else if("input_audio_buffer.speech_started"===e.type){const t=this._rawSessionConfig?.audio?.input?.turn_detection?.interrupt_response??!1;this.interrupt(!t)}else if("response.created"===e.type)this.#a=!0;else if("response.done"===e.type)this.#a=!1;else if("session.created"===e.type){this._tracingConfig=e.session.tracing;const t=void 0===i.tracing?"auto":i.tracing;this._updateTracingConfig(t)}})),n.addEventListener("close",(()=>{this.#s={status:"disconnected",websocket:void 0},this.emit("connection_change",this.#s.status),this._onClose()}))}async connect(t){const e=t.model??this.currentModel;this.currentModel=e,this.#e=await this._getApiKey(t);const i=t.callId;let n;t.url?(n=t.url,this.#u=t.url):n=i?`wss://api.openai.com/v1/realtime?call_id=${i}`:this.#u?this.#u:`wss://api.openai.com/v1/realtime?model=${this.currentModel}`,this.#o=n;const o={...t.initialSessionConfig||{},model:this.currentModel};await new Promise(((t,e)=>{this.#g(t,e,o).catch(e)})),await this.updateSessionConfig(o)}sendEvent(t){if(!this.#s.websocket)throw new Error("WebSocket is not connected. Make sure you call `connect()` before sending events.");this.#s.websocket.send(JSON.stringify(t))}close(){this.#s.websocket?.close(),this.#l=void 0,this._firstAudioTimestamp=void 0,this._audioLengthMs=0,this.#c=void 0}mute(t){throw new Error("Mute is not supported for the WebSocket transport. You have to mute the audio input yourself.")}sendAudio(t,e={}){"connected"===this.#s.status&&super.sendAudio(t,e)}_cancelResponse(){this.#a&&(this.sendEvent({type:"response.cancel"}),this.#a=!1)}_interrupt(t,e=!0){if(t<0)return;e&&this._cancelResponse();const i=this._audioLengthMs??Number.POSITIVE_INFINITY,n=Math.max(0,Math.floor(Math.min(t,i)));this.emit("audio_interrupted"),this.sendEvent({type:"conversation.item.truncate",item_id:this.#l,content_index:this.#c,audio_end_ms:n})}interrupt(t=!0){if(!this.#l||"number"!=typeof this._firstAudioTimestamp)return;const e=Date.now()-this._firstAudioTimestamp;e>=0&&this._interrupt(e,t),this.#h()}}const zt=Symbol("backgroundResult");function Xt(t){return{[zt]:!0,content:t}}function Yt(t){return"object"==typeof t&&null!==t&&zt in t}function Vt(t){return"function"===t.type||"hosted_tool"===t.type&&"hosted_mcp"===t.name}function Qt(t){if("function"===t.type)return t;if("hosted_tool"===t.type&&"hosted_mcp"===t.name){const e=t.providerData.server_url&&t.providerData.server_url.length>0?t.providerData.server_url:void 0;return{type:"mcp",server_label:t.providerData.server_label,server_url:e,headers:t.providerData.headers,allowed_tools:t.providerData.allowed_tools,require_approval:t.providerData.require_approval}}throw new r(`Invalid tool type: ${t}`)}class Zt extends d{initialAgent;options;#_;#y;#f;#v;#b=[];#w;#I={};#A=[];#x;#C={};#S=!1;#T=new Map;#j=[];#k=function(){return JSON.parse(JSON.stringify(Wt))}();#M=!0;constructor(t,e={}){super(),this.initialAgent=t,this.options=e,void 0===e.transport&&"undefined"!=typeof window&&void 0!==window.RTCPeerConnection||"webrtc"===e.transport?this.#_=new Bt:"websocket"===e.transport||void 0===e.transport?this.#_=new $t:this.#_=e.transport,this.#y=t,this.#v=new a({...e.context??{},history:this.#A}),this.#b=(e.outputGuardrails??[]).map(E),this.#w={debounceTextLength:(e.outputGuardrailSettings??{}).debounceTextLength??100},this.#x=e.historyStoreAudio??!1,this.#M=e.automaticallyTriggerResponseForMcpToolCalls??!0}get transport(){return this.#_}get currentAgent(){return this.#y}get usage(){return this.#v.usage}get context(){return this.#v}get muted(){return this.#_.muted}get history(){return this.#A}get availableMcpTools(){return this.#j}async#E(t){this.#y=t;const e=await this.#y.getEnabledHandoffs(this.#v),i=e.map((t=>t.getHandoffAsFunctionTool())),n=(await this.#y.getAllTools(this.#v)).filter(Vt).map(Qt),o=void 0!==this.#y.tools||void 0!==this.#y.mcpServers,s=e.length>0;this.#f=o||s?[...n,...i]:void 0,this.#R()}async#D(t={}){const e=t??{},i=this.options.config??{},n=await this.#y.getSystemPrompt(this.#v),o=t=>{const e=t.audio;return e?.output?.voice},s=this.options.tracingDisabled?null:this.options.workflowName?{workflow_name:this.options.workflowName}:"auto";null!==s&&"auto"!==s?(this.options.groupId&&(s.group_id=this.options.groupId),this.options.traceMetadata&&(s.metadata=this.options.traceMetadata)):(this.options.groupId||this.options.traceMetadata)&&F.warn("In order to set traceMetadata or a groupId you need to specify a workflowName.");const r=o(e)??o(i),a=e.voice??i.voice,p=void 0!==r?r:void 0!==a?a:this.#y.voice,u={...{...this.#k??{},...i,...e},instructions:n,voice:p,model:this.options.model,tools:this.#f,tracing:s,prompt:"function"==typeof this.#y.prompt?await this.#y.prompt(this.#v,this.#y):this.#y.prompt};return this.#k=u,u}async getInitialSessionConfig(t={}){return await this.#E(this.initialAgent),this.#D({...this.options.config??{},...t??{}})}static async computeInitialSessionConfig(t,e={},i={}){const n=new Zt(t,e);try{return await n.getInitialSessionConfig(i)}finally{n.close()}}async updateAgent(t){return this.#y.emit("agent_handoff",this.#v,t),this.emit("agent_handoff",this.#v,this.#y,t),await this.#E(t),await this.#_.updateSessionConfig(await this.#D()),t}async#O(t,e){const i=await e.onInvokeHandoff(this.#v,t.arguments);this.#y.emit("agent_handoff",this.#v,i),this.emit("agent_handoff",this.#v,this.#y,i),await this.#E(i),await this.#_.updateSessionConfig(await this.#D());const n=p(i);return this.#_.sendFunctionCallOutput(t,n,!0),i}async#L(e,i){this.#v.context.history=JSON.parse(JSON.stringify(this.#A));let n=e.arguments;i.parameters&&(n=h(i.parameters)?i.parameters.parse(n):JSON.parse(n));if(await i.needsApproval(this.#v,n,e.callId)){const n=this.context.isToolApproved({toolName:i.name,callId:e.callId});if(!1===n){this.emit("agent_tool_start",this.#v,this.#y,i,{toolCall:e}),this.#y.emit("agent_tool_start",this.#v,i,{toolCall:e});const t="Tool execution was not approved.";return this.#_.sendFunctionCallOutput(e,t,!0),this.emit("agent_tool_end",this.#v,this.#y,i,t,{toolCall:e}),void this.#y.emit("agent_tool_end",this.#v,i,t,{toolCall:e})}if(void 0===n)return void this.emit("tool_approval_requested",this.#v,this.#y,{type:"function_approval",tool:i,approvalItem:new t(e,this.#y)})}this.emit("agent_tool_start",this.#v,this.#y,i,{toolCall:e}),this.#y.emit("agent_tool_start",this.#v,i,{toolCall:e}),this.#v.context.history=JSON.parse(JSON.stringify(this.#A));const o=await i.invoke(this.#v,e.arguments,{toolCall:e});let s;Yt(o)?(s=g(o.content),this.#_.sendFunctionCallOutput(e,s,!1)):(s=g(o),this.#_.sendFunctionCallOutput(e,s,!0)),this.emit("agent_tool_end",this.#v,this.#y,i,s,{toolCall:e}),this.#y.emit("agent_tool_end",this.#v,i,s,{toolCall:e})}async#P(t){const e=await this.#y.getEnabledHandoffs(this.#v),i=new Map(e.map((t=>[t.toolName,t]))),n=await this.#y.getAllTools(this.#v),o=new Map(n.map((t=>[t.name,t]))),s=i.get(t.name);if(s)await this.#O(t,s);else{const e=o.get(t.name);if(!e||"function"!==e.type)throw new u(`Tool ${t.name} not found`);await this.#L(t,e)}}async#N(t,e,i){if(0===this.#b.length)return;const n={agent:this.#y,agentOutput:t,context:this.#v},o=(await Promise.all(this.#b.map((t=>t.run(n))))).find((t=>t.output.tripwireTriggered));if(o){if(this.#C[e])return;this.#C[e]=!0;const t=new l(`Output guardrail triggered: ${JSON.stringify(o.output.outputInfo)}`,o);this.emit("guardrail_tripped",this.#v,this.#y,t,{itemId:i}),this.interrupt();const n=`\n⚠️ Your last answer was blocked. \nFailed Guardrail Reason: ${(s=o).guardrail.policyHint}. \nFailure Details: ${JSON.stringify(s.output.outputInfo??{})}. \nPlease respond again following policy. Apologize for not being able to answer the question (while avoiding the specific reason) and divert discussion back to an approved topic immediately and not invite more discussion.\n`.trim();this.sendMessage(n)}else var s}#K(){this.#_.on("*",(t=>{if(this.emit("transport_event",t),"conversation.item.input_audio_transcription.completed"===t.type)try{const e=t;this.#A=C(this.#A,e,this.#x),this.#v.context.history=this.#A,this.emit("history_updated",this.#A)}catch(t){this.emit("error",{type:"error",error:t})}})),this.#_.on("mcp_tools_listed",(({serverLabel:t,tools:e})=>{try{this.#T.set(t,e??[]),this.#R()}catch(t){this.emit("error",{type:"error",error:t})}})),this.#_.on("audio",(t=>{this.#S||(this.#S=!0,this.emit("audio_start",this.#v,this.#y)),this.emit("audio",t)})),this.#_.on("turn_started",(()=>{this.#S=!1,this.emit("agent_start",this.#v,this.#y),this.#y.emit("agent_start",this.#v,this.#y)})),this.#_.on("turn_done",(t=>{const e=t.response.output[t.response.output.length-1],i=A(e)??"",n=e?.id??"";this.emit("agent_end",this.#v,this.#y,i),this.#y.emit("agent_end",this.#v,i),this.#N(i,t.response.id,n)})),this.#_.on("audio_done",(()=>{this.#S&&(this.#S=!1),this.emit("audio_stopped",this.#v,this.#y)}));let t,e=0;this.#_.on("audio_transcript_delta",(i=>{try{const n=i.delta,o=i.itemId,s=i.responseId;t!==o&&(t=o,e=0);const r=(this.#I[o]??"")+n;if(this.#I[o]=r,this.#w.debounceTextLength<0)return;const a=Math.floor(r.length/this.#w.debounceTextLength);a>e&&(e=a,this.#N(r,s,o))}catch(t){this.emit("error",{type:"error",error:t})}})),this.#_.on("item_update",(t=>{try{const e=!this.#A.some((e=>e.itemId===t.itemId));if(this.#A=C(this.#A,t,this.#x),this.#v.context.history=this.#A,e){const e=this.#A.find((e=>e.itemId===t.itemId));e&&this.emit("history_added",e)}this.emit("history_updated",this.#A)}catch(t){this.emit("error",{type:"error",error:t})}})),this.#_.on("item_deleted",(t=>{try{this.#A=this.#A.filter((e=>e.itemId!==t.itemId)),this.#v.context.history=this.#A,this.emit("history_updated",this.#A)}catch(t){this.emit("error",{type:"error",error:t})}})),this.#_.on("function_call",(async t=>{try{await this.#P(t)}catch(t){F.error("Error handling function call",t),this.emit("error",{type:"error",error:t})}})),this.#_.on("usage_update",(t=>{this.#v.usage.add(t)})),this.#_.on("audio_interrupted",(()=>{this.#S&&(this.#S=!1),this.emit("audio_interrupted",this.#v,this.#y)})),this.#_.on("error",(t=>{this.emit("error",t)})),this.#_.on("mcp_tool_call_completed",(t=>{this.emit("mcp_tool_call_completed",this.#v,this.#y,t),this.#M&&this.#_.sendEvent({type:"response.create"})})),this.#_.on("mcp_approval_request",(t=>{this.emit("tool_approval_requested",this.#v,this.#y,{type:"mcp_approval_request",approvalItem:j(this.#y,t)})}))}#R(){const t=this.#f?.filter((t=>"mcp"===t.type)),e=t=>{const e=t.allowed_tools;if(e)return Array.isArray(e)?e:e&&Array.isArray(e.tool_names)?e.tool_names:void 0},i=new Map;for(const n of t){const t=this.#T.get(n.server_label)??[],o=e(n);for(const e of t)o&&!o.includes(e.name)||i.has(e.name)||i.set(e.name,e)}const n=Array.from(i.values()),o=this.#j;(o.length!==n.length||JSON.stringify(o.map((t=>t.name)).sort())!==JSON.stringify(n.map((t=>t.name)).sort()))&&(this.#j=n,this.emit("mcp_tools_changed",this.#j))}async connect(t){await this.#E(this.initialAgent),this.#K(),await this.#_.connect({apiKey:t.apiKey??this.options.apiKey,model:this.options.model,url:t.url,callId:t.callId,initialSessionConfig:await this.#D(this.options.config)}),this.#A=[],this.emit("history_updated",this.#A)}updateHistory(t){let e;e="function"==typeof t?t(this.#A):t,this.#_.resetHistory(this.#A,e)}sendMessage(t,e={}){this.#_.sendMessage(t,e)}addImage(t,{triggerResponse:e=!0}={}){this.#_.addImage(t,{triggerResponse:e})}mute(t){this.#_.mute(t)}close(){this.#C={},this.#_.close()}sendAudio(t,e={}){this.#_.sendAudio(t,e)}interrupt(){this.#_.interrupt()}async approve(t,e={alwaysApprove:!1}){this.#v.approveTool(t,e);const i=t.toolName??t.rawItem.name,n=this.#y.tools.find((t=>t.name===i));if(n&&"function"===n.type&&"function_call"===t.rawItem.type)await this.#L(t.rawItem,n);else{if("hosted_tool_call"!==t.rawItem.type)throw new u(`Tool ${i??"unknown"} not found`);{e.alwaysApprove&&F.warn("Always approving MCP tools is not supported. Use the allowed tools configuration instead.");const i=k(t);this.#_.sendMcpResponse(i,!0)}}}async reject(t,e={alwaysReject:!1}){this.#v.rejectTool(t,e);const i=t.toolName??t.rawItem.name,n=this.#y.tools.find((t=>t.name===i));if(n&&"function"===n.type&&"function_call"===t.rawItem.type)await this.#L(t.rawItem,n);else{if("hosted_tool_call"!==t.rawItem.type)throw new u(`Tool ${i??"unknown"} not found`);{e.alwaysReject&&F.warn("Always rejecting MCP tools is not supported. Use the allowed tools configuration instead.");const i=k(t);this.#_.sendMcpResponse(i,!1)}}}}class te extends $t{constructor(t={}){super(t)}static async buildInitialConfig(t,e={},i={}){const n=await Zt.computeInitialSessionConfig(t,e,i);return(new te).buildSessionPayload(n)}sendAudio(t,e={}){throw new Error("OpenAIRealtimeSIP does not support sending audio buffers; audio is handled by the SIP call.")}async connect(t){if(!t.callId)throw new r("OpenAIRealtimeSIP requires `callId` in the connect options.");await super.connect(t)}}const ee={base64ToArrayBuffer:w,arrayBufferToBase64:I,getLastTextFromAudioOutputMessage:A};export{Ut as DEFAULT_OPENAI_REALTIME_MODEL,Wt as DEFAULT_OPENAI_REALTIME_SESSION_CONFIG,Ht as OpenAIRealtimeBase,te as OpenAIRealtimeSIP,Bt as OpenAIRealtimeWebRTC,$t as OpenAIRealtimeWebSocket,M as RealtimeAgent,Zt as RealtimeSession,Xt as backgroundResult,Yt as isBackgroundResult,ee as utils};export default null;
//# sourceMappingURL=/sm/04ad1446f5cbec4c4efa15f4bf1459666a8de51c68545145ebc91085631ae086.map